name: $(Date:yyyyMMdd)$(Rev:.r)

pool:
  vmImage: 'ubuntu-16.04'

trigger:
  branches: 
    include:
      - master
      - feature/terraform
  paths:
    include:
      - src/WhackAMole.KubeAdmin
      - src/WhackAMole.KubeServices
      - src/Dockerfile.KubeAdmin
      - src/kube-admin.ci.yml

variables:
  acr_name: mtcdensandboxdemo
  image_name: whack-a-mole/kube-admin:$(Build.BuildNumber)

steps:
- task: AzureCLI@1
  displayName: 'Azure CLI '
  inputs:
    azureSubscription: 'MTC Denver Sandbox (b0e04a4a-a321-4b66-b8fd-13715262ba3c)'
    scriptLocation: inlineScript
    failOnStandardError: true
    inlineScript: |
      # User ACR to build and tag our container
      az acr build -r $(acr_name) -t $(image_name) -f ./src/Dockerfile.KubeAdmin ./src >> build.log
      echo ACR BUILD - $?

      # Package the helm chart and push it to ACR
      helm init --client-only >> build.log
      echo HELM INIT - $?

      helm package charts/kube-admin --version $(Build.BuildNumber) >> build.log
      echo HELM PACKAGE - $?

      az acr helm push -n $(acr_name) kube-admin-$(Build.BuildNumber).tgz >> build.log
      echo HELM PUSH - $?
